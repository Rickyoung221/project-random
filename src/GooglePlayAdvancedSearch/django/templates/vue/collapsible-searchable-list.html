{% verbatim %}

<style>
	.expandable {
		position: relative;
	}

	.expandable .expanded::before {
		content: "";
		background-image: url("/static/images/expanded.png");
		background-repeat: no-repeat;
		background-size: contain;
		width: 10px;
		height: 10px;
		display: inline-block;
		margin-right: 0.5em;
	}

	.expandable .expandable::before {
		content: "";
		background-image: url(/static/images/expandable.png);
		background-repeat: no-repeat;
		background-size: contain;
		width: 10px;
		height: 10px;
		display: inline-block;
		margin-right: 0.5em;
	}

	.expandable ul {
		background-color: rgba(255, 255, 255, 0.8);
		padding-left: 0;
		padding-right: 0.5em;
		margin-top: 0.5em;
	}

	.expandable ul > li {
		list-style: none;
	}

	.searchableList {
		position: absolute;
		border: blue solid 1px;
		padding-top: 0.5em;
	}

	.listFilterBox {
		width: calc(100% - 1em);
		margin-left: auto;
		margin-right: auto;
		display: block;
	}
</style>

<script type="text/x-template" id="collapsible-searchable-list">
	<div class="filter expandable">
		<!--  v-bind:disabled is the same as :disabled -->
		<button v-bind:class="{expanded: isExpanded, expandable:!isExpanded}" :disabled="!hasItems"
				v-on:click="isExpanded=!isExpanded;">{{summary}}
		</button>
		<div v-show="isExpanded" class="searchableList">
			<input v-model="userInput" class="listFilterBox" type="text" :placeholder="`find ${label} here`">
			<ul style="width: 500px">
				<li v-for="p in filteredItems">
					<!-- data binding must use single or double quotes. Inside it, you can use tick (`). -->
					<label> <input type="checkbox" v-model="p.checked"> {{ p.permission.name }} </label>
				</li>
			</ul>
		</div>
	</div>
</script>


<script>
	Vue.component('collapsible-searchable-list', {
		template: "#collapsible-searchable-list",
		props: ['items', 'isExpanded', 'label'],
		data: function () {
			return {userInput: ""};
		},
		computed: {
			hasItems: function () {
				return this.items && this.items.length > 0;
			},
			summary: function () {
				// `this` 指向 vue 实例
				if (!this.hasItems)
					return 'No ' + this.label + ' available';

				//I like groupBy because I can use checkedPermissions[true], checkedPermissions[false] to access it.
				//Another way is to use partition, then you access it by checkedPermissions[0], checkedPermissions[1].
				const checkedItems = _.groupBy(this.items, p => p.checked);
				if (!checkedItems[false])
					return "Allow all " + this.label;
				if (checkedItems[false] && checkedItems[false].length <= 2)
					return 'Disallow ' + checkedItems[false].length + ": " + checkedItems[false].map(p => p.permission.name).join(', ');
				if (checkedItems[true] && checkedItems[true].length <= 2)
					return 'Allow ' + checkedItems[true].length + ": " + checkedItems[true].map(p => p.permission.name).join(', ');

				return 'Allow ' + checkedItems[true].length + ' ' + this.label;
			},

			filteredItems: function () {
				if (this.userInput && this.items)
					return this.items.filter(item => {
							return item.permission.name.toUpperCase().includes(this.userInput.toUpperCase());
						}
					);
				else
					return this.items;
			},

		}
	});
</script>
{% endverbatim %}