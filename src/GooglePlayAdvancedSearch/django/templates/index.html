<!DOCTYPE html>
<html>
<head>
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<title></title>
	{#    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>#}
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
	<style>
		label {
			display: block;
		}

		.expandableList {
			position: relative;
		}

		.expandableList .expanded::before {
			content: "";
			background-image: url("/static/images/expanded.png");
			background-repeat: no-repeat;
			background-size: contain;
			width: 10px;
			height: 10px;
			display: inline-block;
			margin-right: 0.5em;
		}

		.expandableList .expandable::before {
			content: "";
			background-image: url(/static/images/expandable.png);
			background-repeat: no-repeat;
			background-size: contain;
			width: 10px;
			height: 10px;
			display: inline-block;
			margin-right: 0.5em;
		}

		.expandableList ul {
			position: absolute;
			background-color: rgba(255, 255, 255, 0.8);
			padding-left: 0;
			padding-right: 0.5em;
			border: blue solid 1px;
			margin-top: 0.5em;
		}

		.expandableList ul > li {
			list-style: none;
		}
	</style>
</head>
<body>

<h1><a href="/" style="text-decoration: none;">Google Play Advanced Search</a></h1>

<div>
	<form action="/advance_search/keyword_search" method="post">
		{% csrf_token %}
		<input type="text" name="keyword" value={{ previous_keyword }}>
		<input type="submit" value="Search">
	</form>
</div>

<button class="button", onclick="hidecategory()">Category</button>

<div id="category">
    {% for category in categories %}
        <label> <input type="checkbox"  value="category"> {{category}} </label>
    {% endfor %}
</div>

<br>


{% verbatim %}
<div id="permissions" class="expandableList">
	<button v-bind:class="{expanded: isExpanded, expandable:!isExpanded}" v-on:click="isExpanded=!isExpanded">{{summary}}</button>
	<ul v-show="isExpanded">
		<li v-for="p in permissions">
			<label> <input type="checkbox" value="permission" v-model="p.checked"> {{ p.name }} </label>
		</li>
	</ul>
</div>
{% endverbatim %}

{% if app_infos %}
	{% for app_info in app_infos %}
        {% if app_info.name %}
        <li><a href="https://play.google.com/store/apps/details?id={{ app_info.id }}">{{ app_info.name }}</a>
            <img src="{{ app_info.app_icon }}">
            <br>
            <button type="button" class="collapsible">+</button>
            <div class="app_detail_{{ app_info.id }}" style="display: none">
                <ul>
                    <li>rating: {{ app_info.rating }}</li>
                    <li>num_reviews: {{ app_info.num_reviews }}</li>
                    <li>install_fee: ${{ app_info.install_fee }}</li>
                    <li>inAppPurchases: {{ app_info.inAppPurchases }}</li>
                </ul>
            </div>
        </li>

        {% else %}
        <li><a href="https://play.google.com/store/apps/details?id={{ app_info.id }}">https://play.google.com/store/apps/details?id={{ app_info.id }}</a></li>
        {% endif %}
	{% endfor %}
{% endif %}


<script>
    var coll = document.getElementsByClassName("collapsible");
    for (var i=0; i<coll.length; i++){
        coll[i].addEventListener("click", function(){
            this.classList.toggle("active");
            var app_detail = this.nextElementSibling;
            if (app_detail.style.display === "block"){
                app_detail.style.display = "none";
            } else{
                app_detail.style.display = "block";
            }
        });
    }
</script>

<script>
    function hidecategory() {
        var x = document.getElementById("category");
        if (x.style.display === "none")
        {
            x.style.display = "block";
        }
        else
        {
            x.style.display = "none";
        }
    }
    function hidepermission()
    {
        var x = document.getElementById("permission");
        if (x.style.display === "none")
        {
            x.style.display = "block";
        }
        else
        {
            x.style.display = "none";
        }
    }
</script>

<p>We have recorded <span id="appCount"></span> apps, and it's increasing!</p>

<marquee> TEAM RANDOM: <br>
Weikeng Yang <br>
Qiqi Gu <br>
Shuhua Zhan <br>
Dongyao Liang <br>
Yuchen Hu <br>
</marquee>

<script>
	fetch('{% url 'Api/AppCount' %}'{% if refetchAppCount %}, {cache: "no-cache"} {% endif %}).then(response => response.text()).then(text => {
			$("#appCount").text(text);
		}
	);


	fetch('{% url 'Api/Permissions' %}').then(r => r.json()).then(data => {
		const vm = new Vue({
			el: '#permissions',
			data: {
				permissions: data.map(p => {
					return {name: p, checked: true}
				}),
				isExpanded: false
			},
			computed: {
				summary: function () {
					// `this` 指向 vm 实例

					//I like groupBy because I can use checkedPermissions[true], checkedPermissions[false] to access it.
					//Another way is to use partition, then you access it by checkedPermissions[0], checkedPermissions[1].
					const checkedPermissions = _.groupBy(this.permissions, p => p.checked);
					if (checkedPermissions[false] != null && checkedPermissions[false].length === 0)
						return "Allow all permissions";
					if (checkedPermissions[false] != null && checkedPermissions[false].length <= 2)
						return 'Disallow ' + checkedPermissions[false].length + ": " + checkedPermissions[false].map(p => p.name).join(', ');
					if (checkedPermissions[true] != null && checkedPermissions[true].length <= 2)
						return 'Allow ' + checkedPermissions[true].length + ": " + checkedPermissions[true].map(p => p.name).join(', ');

					return 'Allow ' + checkedPermissions[true].length + ' permissions';
				}
			}
		});
	});
</script>
</body>
</html>


