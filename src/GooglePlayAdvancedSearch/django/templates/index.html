<!DOCTYPE html>
<html>
<head>
	<title></title>
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

	{#    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>#}
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
	<style>
		label {
			display: block;
		}

		.expandableList {
			position: relative;
		}

		.expandableList .expanded::before {
			content: "";
			background-image: url("/static/images/expanded.png");
			background-repeat: no-repeat;
			background-size: contain;
			width: 10px;
			height: 10px;
			display: inline-block;
			margin-right: 0.5em;
		}

		.expandableList .expandable::before {
			content: "";
			background-image: url(/static/images/expandable.png);
			background-repeat: no-repeat;
			background-size: contain;
			width: 10px;
			height: 10px;
			display: inline-block;
			margin-right: 0.5em;
		}

		.bear {
			/* A fallback keyword value is required when using a URL */
			cursor: url(/static/images/bear.png), auto;
		}

		.expandableList ul {
			position: absolute;
			background-color: rgba(255, 255, 255, 0.8);
			padding-left: 0;
			padding-right: 0.5em;
			border: blue solid 1px;
			margin-top: 0.5em;
		}

		.expandableList ul > li {
			list-style: none;
		}

		.filters {
			margin: 1em 0;
		}

		.filters .filter {
			display: inline-block;
		}

		.filters .filter:not(:last-child) {
			padding-right: 1em;
			border-right: 2px darkgreen dotted;
		}

		.filters .filter:not(:first-child) {
			padding-left: 1em;
		}


    </style>
</head>
<body>

<h1><a href="/" style="text-decoration: none;">Google Play Advanced Search</a></h1>

{% verbatim %}
<div id="searchTool">
	<div id="searchBox">
		<input type="text" name="keyword" v-model='keyword'>
		<a :href=`/search?${queryString}` class="btn btn-primary">Search</a>
	</div>

	<div class="filters">
		<label class="filter"><input type="checkbox" checked>Allow in-app purchase</label>
		<label class="filter"><input type="checkbox" checked>Free install</label>
		<label class="filter"><input type="checkbox" checked>Allow ads</label>

		<div class="filter">
			Rating >
			<select style="width: 3em">
				<option>0</option>
				<option>1</option>
				<option>2</option>
				<option>3</option>
				<option>4</option>
			</select>
		</div>
		<div id="permissions" class="filter expandableList">
			<!--  v-bind:disabled is the same as :disabled -->
			<button v-bind:class="{expanded: permissionFilter.isExpanded, expandable:!permissionFilter.isExpanded}" :disabled="!hasPermissions" v-on:click="permissionFilter.isExpanded=!permissionFilter.isExpanded">{{permissionSummary}}</button>
			<ul v-show="permissionFilter.isExpanded" style="width: 500px">
				<li v-for="p in permissionFilter.items">
					<label> <input type="checkbox" :value=`permission${p.item.id}` v-model="p.checked"> {{ p.item.name }} </label>
				</li>
			</ul>
		</div>
		<div id="categories" class="filter expandableList">
			<button v-bind:class="{expanded: categoryFilter.isExpanded, expandable:!categoryFilter.isExpanded}" :disabled="!hasCategories" v-on:click="categoryFilter.isExpanded=!categoryFilter.isExpanded">{{categorySummary}}</button>
			<ul v-show="categoryFilter.isExpanded" style="width: 200px">
				<li v-for="p in categoryFilter.items">
					<label> <input type="checkbox" :value=`category${p.item.id}` v-model="p.checked"> {{ p.item.name }} </label>
				</li>
			</ul>
		</div>
	</div>
</div>

{% endverbatim %}

{% if isSearch %}
	{% verbatim %}
	<div id="appsList">
		<li v-for="app in apps">
			<a :href=`https://play.google.com/store/apps/details?id=${app.id}`>{{ app.appName }}</a>
			<img :src="app.app_icon">
			<br>
			<button type="button" class="collapsible">+</button>
			<div>
				<ul>
					<li>rating: {{ app.rating }}</li>
					<li>num_reviews: {{ app.num_reviews }}</li>
					<li>install_fee: ${{ app.install_fee }}</li>
					<li>inAppPurchases: {{ app.inAppPurchases }}</li>
				</ul>
			</div>
		</li>
	</div>
	{% endverbatim %}
{% endif %}

<p>We have recorded <span id="appCount"></span> apps, and it's increasing!</p>

<div class="bear">TEAM RANDOM: <br>
Weikeng Yang <br>
Qiqi Gu <br>
Shuhua Zhan <br>
Dongyao Liang <br>
Yuchen Hu <br> </div>

<script>
	const currentQuery = new URLSearchParams(location.search);
	//Cannot write map(parseInt) because parseInt can accept 2 parameters!
	const excludedPIds = currentQuery.has('pids') ? currentQuery.get('pids').split(',').map(n => parseInt(n)) : [];
	const excludedCIds = currentQuery.has('cids') ? currentQuery.get('cids').split(',').map(n => parseInt(n)) : [];

	const searchTool = new Vue({
		el: '#searchTool',
		data: {
			keyword: currentQuery.has('q') ? currentQuery.get('q') : "",
			permissionFilter: {
				items: [],
				isExpanded: false
			},
			categoryFilter: {
				items: [],
				isExpanded: false
			}
		},
		computed: {
			hasPermissions: function () {
				return this.permissionFilter.items.length > 0;
			},
			permissionSummary: function () {
				// `this` 指向 vue 实例
				if (!this.hasPermissions)
					return 'No permissions available';

				//I like groupBy because I can use checkedPermissions[true], checkedPermissions[false] to access it.
				//Another way is to use partition, then you access it by checkedPermissions[0], checkedPermissions[1].
				const checkedPermissions = _.groupBy(this.permissionFilter.items, p => p.checked);
				if (!checkedPermissions[false])
					return "Allow all permissions";
				if (checkedPermissions[false] && checkedPermissions[false].length <= 2)
					return 'Disallow ' + checkedPermissions[false].length + ": " + checkedPermissions[false].map(p => p.item.name).join(', ');
				if (checkedPermissions[true] && checkedPermissions[true].length <= 2)
					return 'Allow ' + checkedPermissions[true].length + ": " + checkedPermissions[true].map(p => p.item.name).join(', ');

				return 'Allow ' + checkedPermissions[true].length + ' permissions';
			},

			hasCategories: function () {
				return this.categoryFilter.items.length > 0;
			},
			categorySummary: function () {
				// `this` 指向 vue 实例
				if (!this.hasCategories)
					return 'No categories available';

				//I like groupBy because I can use checkedPermissions[true], checkedPermissions[false] to access it.
				//Another way is to use partition, then you access it by checkedPermissions[0], checkedPermissions[1].
				const checkedPermissions = _.groupBy(this.categoryFilter.items, p => p.checked);
				if (!checkedPermissions[false])
					return "Allow all categories";
				if (checkedPermissions[false] && checkedPermissions[false].length <= 2)
					return 'Disallow ' + checkedPermissions[false].length + ": " + checkedPermissions[false].map(p => p.item.name).join(', ');
				if (checkedPermissions[true] && checkedPermissions[true].length <= 2)
					return 'Allow ' + checkedPermissions[true].length + ": " + checkedPermissions[true].map(p => p.item.name).join(', ');

				return 'Allow ' + checkedPermissions[true].length + ' categories';
			},
			queryString: function () {
				let query = `q=${encodeURIComponent(this.keyword)}`;
				let excludedPIds = this.permissionFilter.items.filter(p => !p.checked).map(p => p.item.id).join(',');
				if (excludedPIds)
					query += "&pids=" + excludedPIds;
				let excludedCIds = this.categoryFilter.items.filter(p => !p.checked).map(p => p.item.id).join(',');
				if (excludedCIds)
					query += "&cids=" + excludedCIds;
				return query;
			}
		}
	});

	fetch('{% url 'Api/AppCount' %}'{% if refetchAppCount %}, {cache: "no-cache"} {% endif %}).then(response => response.text()).then(text => {
			$("#appCount").text(text);
		}
	);

	const permissionPromise = fetch('{% url 'Api/Permissions' %}').then(r => r.json()).then(data => {
		searchTool.permissionFilter.items = Object.entries(data).map(p => {
			return {item: {id: parseInt(p[0]), name: p[1]}, checked: !excludedPIds.includes(parseInt(p[0]))}
		});
	});

	const categoryPromise = fetch('{% url 'Api/Categories' %}').then(r => r.json()).then(data => {
		searchTool.categoryFilter.items = Object.entries(data).map(p => {
			return {item: {id: parseInt(p[0]), name: p[1]}, checked: !excludedCIds.includes(parseInt(p[0]))}
		});
	});

	//When we got permission list and category list, then run the following code.
	Promise.all([permissionPromise, categoryPromise]).then(function () {
		fetch("/Api/Search?" + searchTool.queryString).then(r => r.json()).then(data => {
			new Vue({
				el: "#appsList",
				data: {
					apps: data
				}
			});
		});
	});

</script>
</body>
</html>


